version: 2
jobs:
  build:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - checkout
      - run:
          name: Change ACLs on project dir (default user = circleci (1001) and docker needs uid 1000)
          command: |
              sudo apt update
              sudo apt install acl
              # set permissions for future files and folders
              sudo setfacl -dR -m u:1000:rwX -m u:$(whoami):rwX ../project
              # set permissions on the existing files and folders
              sudo setfacl -R -m u:1000:rwX -m u:$(whoami):rwX ../project
      - run:
            name: Create mandatory composer and yarn directories
            command: |
                mkdir -p ~/.composer ~/.cache/yarn
                sudo setfacl -dR -m u:1000:rwX -m u:$(whoami):rwX ~/.composer
                sudo setfacl -R -m u:1000:rwX -m u:$(whoami):rwX ~/.composer
                sudo setfacl -dR -m u:1000:rwX -m u:$(whoami):rwX ~/.cache
                sudo setfacl -R -m u:1000:rwX -m u:$(whoami):rwX ~/.cache
      - run:
          name: Install PHP dependencies
          command: docker run -u www-data -e COMPOSER_HOME=/var/www/.composer -v $(pwd):/srv/pim -v ~/.composer:/var/www/.composer -w /srv/pim --rm akeneo/pim-php-dev:master composer --prefer-dist install
      - run:
          name: Install missing Docker build files
          command: cp vendor/akeneo/pim-community-dev/ docker/cypress/Dockerfile docker/cypress/Dockerfile
      - run:
          name: Launch the PIM in dev mode
          command: make
          environment:
              YARN_REGISTRY: "http://registry.yarnpkg.com"
      - run:
          name: Test login page HTTP status
          command: curl -f http://localhost:8080/
      - run:
          name: Shutdown dev mode
          command: make down
      - run:
          name: Launch the PIM in prod mode
          command: make prod
          environment:
              YARN_REGISTRY: "http://registry.yarnpkg.com"
      - run:
          name: Test login page HTTP status
          command: curl -f http://localhost:8080/

  test_migrations_from_4_0:
      machine:
          image: ubuntu-2004:202101-01
      steps:
          - checkout
          - run:
                name: Change ACLs on project dir (default user = circleci (1001) and docker needs uid 1000)
                command: |
                    sudo apt update
                    sudo apt install acl
                    # set permissions for future files and folders
                    sudo setfacl -dR -m u:1000:rwX -m u:$(whoami):rwX ../project
                    # set permissions on the existing files and folders
                    sudo setfacl -R -m u:1000:rwX -m u:$(whoami):rwX ../project
          - run:
                name: Create mandatory composer and yarn directories
                command: |
                    mkdir -p ~/.composer ~/.cache/yarn
                    sudo setfacl -dR -m u:1000:rwX -m u:$(whoami):rwX ~/.composer
                    sudo setfacl -R -m u:1000:rwX -m u:$(whoami):rwX ~/.composer
                    sudo setfacl -dR -m u:1000:rwX -m u:$(whoami):rwX ~/.cache
                    sudo setfacl -R -m u:1000:rwX -m u:$(whoami):rwX ~/.cache
          - run:
                name: Test migrations from 4.0
                no_output_timeout: 60m
                command: .circleci/test_migrations_from_4_0.sh $CIRCLE_BRANCH
                environment:
                    YARN_REGISTRY: "http://registry.yarnpkg.com"
          - run:
                name: Test login page HTTP status
                command: curl --fail http://localhost:8080/

workflows:
    version: 2

    pull_request:
        jobs:
            - build
            - test_migrations_from_4_0

    nightly:
        triggers:
            - schedule:
                cron: 0 5 * * *
                filters:
                  branches:
                    only:
                      - master
        jobs:
            - build
            - test_migrations_from_4_0
